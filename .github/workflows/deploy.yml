name: Auto Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: [self-hosted, Linux, X64]
    steps:
      # Code is already on the server; just pull latest and rebuild
      - name: Pre-pull base images (retry)
        run: |
          set -e
          for i in 1 2 3 4 5; do
            if docker pull node:20-alpine; then
              break
            fi
            echo "Retry $i...";
            sleep 10
          done
      - name: Pull latest and rebuild
        run: |
          cd /var/www/auth-api
          git fetch origin main
          git reset --hard origin/main
          if command -v docker compose >/dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml up -d --build
          else
            docker-compose -f docker-compose.prod.yml up -d --build
          fi
          if command -v docker compose >/dev/null 2>&1; then
            docker compose -f docker-compose.prod.yml ps
          else
            docker-compose -f docker-compose.prod.yml ps
          fi
